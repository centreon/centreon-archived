<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>Centreon - IT & Network Monitoring</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="Generator" content="Centreon - Copyright (C) 2005 - 2021 Open Source Matters. All rights reserved." />
        <meta name="robots" content="index, nofollow" />
        <meta http-equiv="refresh" content="840">
        <link href="./Themes/Centreon-2/login.css" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="./img/favicon.ico">
        <script type="text/javascript" src="./include/common/javascript/jquery/jquery.min.js"></script>
    </head>
    <body OnLoad="document.login.useralias.focus();">
        <form action="./index.php" method="post" name="login" style="height:370px">
            {if $redirect != ''}
            <input type='hidden' value='{$redirect}' name='redirect'>
            {/if}
            <div class="login_wrapper">
                <div class="LoginInvitLogo">
                    <div class="error_msg" style="visibility: hidden">
                        <span class='msg'></span>
                    </div>
                   <img src="img/centreon.png" alt="Centreon Logo" title="Centreon Logo" />
                </div>
                <div class="logintab">
                    <table id="logintab1" style="text-align:center;" align="center">
                       {if $openIdConnectEnabled == 0 || ($openIdConnectEnabled == 1 && $openIdConnectMode == 1)}
                       <tr>
                            <td align='right'>{$form.useralias.label}</td>
                            <td>{$form.useralias.html}</td>
                        </tr>
                        <tr>
                            <td align='right'>{$form.password.label}</td>
                            <td>{$form.password.html}</td>
                        </tr>
                        <tr>
                            <td colspan="2" align='center'>{$form.submitLogin.html}</td>
                        </tr>
                        {/if}
                        {if $openIdConnectEnabled == 1}
                            <td colspan="2" align='center'><a href="?force=1"><input class="btc bt_info" name="submitLogin" value="Connect with OpenId Connect" type="button"/></a></td>
                        {/if}
                    </table>
                </div>
                <div class="LoginInvitVersion">
                    <span id="LoginInvitcpy">
                        &copy; <a href="mailto:contact@centreon.com">Centreon</a> 2005 - 2021
                    </span>
                    <br>
                    <span>
                        {$centreonVersion}
                    </span>
                </div>
            </div>
        {$form.hidden}
        </form>
        <script type="text/javascript">
            let sendStatistics = Boolean({$sendStatistics});
            {literal}
            jQuery(() => {
                jQuery('form[name="login"]').submit(() => {
                    jQuery('input[type="submit"]').prop('disabled', true)

                    /**
                     * Local Provider Request.
                     */
                    jQuery.ajax({
                        url: '/centreon/authentication/providers/configurations/local',
                        data: JSON.stringify({
                            login: jQuery('input[name="useralias"]').val(),
                            password: jQuery('input[name="password"]').val()
                        }),
                        method: 'POST',
                        contentType: 'application/json'
                    }).done((res) => {
                        let redirectUri = res.redirect_uri;
                        if (
                            sendStatistics === true
                        ) {
                            if (
                                localStorage.getItem('platformData') === null
                                || JSON.parse(localStorage.getItem('platformData')).cacheGenerationDate + (24 * 60 * 60 * 1000) < Date.now()
                            ) {
                                /**
                                 * User parameters Request.
                                 */
                                jQuery.ajax({
                                    url: '/centreon/api/v21.10/configuration/users/current/parameters',
                                    method: 'GET',
                                    contentType: 'application/json'
                                }).done((res) => {
                                    /**
                                     * Initiate variables for data Sending.
                                     */
                                    {/literal}
                                    let uuid = `{$uuid}`;
                                    let nbHosts = parseInt(`{$stats.nb_hosts}`);
                                    let nbServices = parseInt(`{$stats.nb_services}`);
                                    let nbServers = parseInt(`{$stats.nb_central}`)
                                        + parseInt(`{$stats.nb_pollers}`)
                                        + parseInt(`{$stats.nb_remotes}`);
                                    let isRemote = `{$isRemote}`;
                                    let licenseProduct = `{$productLicense}`;
                                    let licenseClient = `{$licenseClientName}`;
                                    {literal}
                                    let platformData = {
                                        cacheGenerationDate: Date.now(),
                                        visitor: {
                                            id: null,
                                            role: null,
                                        },
                                        account: {
                                            name: licenseClient ? licenseClient : null,
                                            uuid: uuid,
                                            serverType: isRemote ? 'remote' : 'central',
                                            licenseType: licenseProduct ? licenseProduct : null,
                                            versionMajor: null,
                                            versionMinor: null,
                                            nb_hosts: nbHosts,
                                            nb_services: nbServices,
                                            nb_servers: nbServers,
                                        }
                                    };
                                    console.log(platformData.cacheGenerationDate);
                                    /**
                                     * Generate id based on first letters of company name, first letters of uuid, and contact id.
                                     */
                                    platformData.visitor.id = platformData.account.name
                                        ? platformData.account.name.substr(0,10) + '-' + uuid.substr(0,8) + '-' + res.id
                                        : uuid.substr(0,8) + '-' + res.id;

                                    if (res.is_admin) {
                                        platformData.visitor.role = 'admin';
                                    }

                                    /**
                                     * Platform versions Request.
                                     */
                                    jQuery.ajax({
                                        url: '/centreon/api/v21.10/platform/versions',
                                        method: 'GET',
                                        contentType: 'application/json'
                                    }).done((res) => {
                                        platformData.account.versionMajor = res.web.major + '.' + res.web.minor;
                                        platformData.account.versionMinor = res.web.version;

                                        /**
                                         * User ACL Actions Request.
                                         */
                                        jQuery.ajax({
                                            url: '/centreon/api/v21.10/users/acl/actions',
                                            method: 'GET',
                                            contentType: 'application/json'
                                        }).done((res) => {

                                            /**
                                             * Check if the user has at least one ACL action.
                                             * If so, the user is an operator.
                                             */
                                            const aclActions = [
                                                ...Object.values(res.host),
                                                ...Object.values(res.metaservice),
                                                ...Object.values(res.service)
                                            ];
                                            if (!aclActions.includes(true)) {
                                                platformData.visitor.role = 'user';
                                            } else if (aclActions.includes(true) && platformData.visitor.role !== 'admin') {
                                                platformData.visitor.role = 'operator';
                                            }

                                            /**
                                             * Save data in local storage and redirect user.
                                             */
                                            localStorage.setItem('platformData', JSON.stringify(platformData));
                                            window.location.href = redirectUri
                                        }).fail((err) => {
                                            jQuery('span.msg').text('Unable to get ACLs.')
                                            jQuery('div.error_msg').css('visibility', '')
                                        })
                                    }).fail((err) => {
                                        jQuery('span.msg').text('Unable to get platform versions.')
                                        jQuery('div.error_msg').css('visibility', '')
                                    })
                                }).fail((err) => {
                                    jQuery('span.msg').text('Unable to get contact informations.')
                                    jQuery('div.error_msg').css('visibility', '')
                                })
                            }
                            window.location.href = redirectUri
                        } else {
                            if(localStorage.getItem('platformData') !== null) {
                                localStorage.removeItem('platformData');
                            }
                            window.location.href = redirectUri
                        }
                    }).fail((err) => {
                        jQuery('span.msg').text('Your credentials are incorrect.')
                        jQuery('div.error_msg').css('visibility', '')
                    }).always(() => {
                        jQuery('input[type="submit"]').prop('disabled', false)
                    })
                    return false;
                });
            });
          // check :
          //  - if login page is in an iframe
          //  - if iframe url is login page with disconnect parameter
          if (window.location.href !== window.parent.location.href
            && window.location.href.match(/\/index.php\?disconnect=1/)
          ) {
            // send event to be manage by react app (redirect to login page)
            var event = new CustomEvent(
              'react.href.disconnect',
              {
                detail: {
                  href: window.location.href
                }
              }
            );
            window.parent.dispatchEvent(event);
          }
        </script>
        {/literal}
    </body>
</html>
