#!/usr/bin/perl -w
###################################################################
# Centreon is developped with GPL Licence 2.0 
#
# GPL License: http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt
#
# Developped by : Julien Mathis - jmathis@merethis.com
#
###################################################################
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
#    For information : contact@centreon.com
####################################################################

use strict;
use warnings;
use RRDs;
use DBI;

use vars qw($mysql_user $mysql_passwd $mysql_host $mysql_database_oreon $mysql_database_ods $opt_h $opt_a $data);
require "@CENTREON_ETC@/conf.pm";
# Define Var lib dir
my $VarLib = "@CENTREON_VARLIB@";

# logAnalyser's lock file
my $lock_file = "$VarLib/logAnalyser.lock";
my $cmdtmp;
my $pid;
if (-e "$lock_file") {
   chomp($pid = `cat $lock_file`);
   my @progTab = split(/\//,$0);
   my $progName = pop(@progTab);
   my $cmd = "ps -p ".$pid." | grep ".$progName;
   $cmdtmp = `$cmd`;
   if (length($cmdtmp) > 0) {
      print("$progName is already running... (pid=$pid)\n");
      exit;
   }
}
$pid = getpgrp(0);
$cmdtmp = `echo $pid > $lock_file`;

my $global_prefix = "@CENTSTORAGE_LIB@/nagios-perf/";
my $tmp_prefix;

my $global_cmd_buffer;
my $global_active_service_latency;
my $global_active_service_execution;
my $global_active_service_last;
my $global_services_states;
my $global_active_host_latency;
my $global_active_host_execution;
my $global_active_host_last;
my $global_hosts_states;
my $dbh = DBI->connect("DBI:mysql:database=".$mysql_database_ods.";host=".$mysql_host, $mysql_user, $mysql_passwd, {'RaiseError' => 1});

sub trim($) {
    my $string = shift;
    $string =~ s/^\s+//;
    $string =~ s/\s+$//;
    return $string;
}

sub rrd_process {
    my($str, $is_localhost, $must_update_ds, $ns_id) = @_;
    my @tab;
    my $match;
    my $interval = 600;
    my $j;
    my $error;
	my $query_str;
	
    $str =~ s/\n/:/g;
    @tab = split(/:/, $str);
    chomp(@tab);
    $j = 0;
    
    if ($must_update_ds) {
    	RRDs::tune ($global_cmd_buffer, "--data-source-rename", "Used:In_Use");
    	RRDs::tune ($global_cmd_buffer, "--data-source-rename", "High:Max_Used");
    	RRDs::tune ($global_cmd_buffer, "--data-source-rename", "Total:Total_Available");
    	
    	RRDs::tune ($global_active_service_latency, "--data-source-rename", "Used:Min");
    	RRDs::tune ($global_active_service_latency, "--data-source-rename", "High:Max");
    	RRDs::tune ($global_active_service_latency, "--data-source-rename", "Total:Average");
    	
    	RRDs::tune ($global_active_service_execution, "--data-source-rename", "Used:Min");
    	RRDs::tune ($global_active_service_execution, "--data-source-rename", "High:Max");
    	RRDs::tune ($global_active_service_execution, "--data-source-rename", "Total:Average");
    	
    	RRDs::tune ($global_active_service_last, "--data-source-rename", "T1:Last_Min");
    	RRDs::tune ($global_active_service_last, "--data-source-rename", "T5:Last_5_Min");
    	RRDs::tune ($global_active_service_last, "--data-source-rename", "T15:Last_15_Min");
    	RRDs::tune ($global_active_service_last, "--data-source-rename", "T60:Last_Hour");
    	
    	RRDs::tune ($global_active_host_latency, "--data-source-rename", "Used:Min");
    	RRDs::tune ($global_active_host_latency, "--data-source-rename", "High:Max");
    	RRDs::tune ($global_active_host_latency, "--data-source-rename", "Total:Average");
    	
    	RRDs::tune ($global_active_host_execution, "--data-source-rename", "Used:Min");
    	RRDs::tune ($global_active_host_execution, "--data-source-rename", "High:Max");
    	RRDs::tune ($global_active_host_execution, "--data-source-rename", "Total:Average");
    	
    	RRDs::tune ($global_active_host_last, "--data-source-rename", "T1:Last_Min");
    	RRDs::tune ($global_active_host_last, "--data-source-rename", "T5:Last_5_Min");
    	RRDs::tune ($global_active_host_last, "--data-source-rename", "T15:Last_15_Min");
    	RRDs::tune ($global_active_host_last, "--data-source-rename", "T60:Last_Hour");
    }
    
    $query_str = "";
    foreach $match (@tab) {		
		if ($match =~ /Used\/High\/Total Command Buffers/) {
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)/;
		    if (!-e $global_cmd_buffer) {
				RRDs::create ($global_cmd_buffer, "-s $interval", "DS:In_Use:GAUGE:300:0:U", "DS:Max_Used:GAUGE:300:0:U", "DS:Total_Available:GAUGE:300:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_cmd_buffer, "--template=In_Use", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_cmd_buffer, "--template=Max_Used", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_cmd_buffer, "--template=Total_Available", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Buffer Usage', 'In_Use', '$1'), ";
		    $query_str .= "('$ns_id', 'Buffer Usage', 'Max_Used', '$2'), ";
		    $query_str .= "('$ns_id', 'Buffer Usage', 'Total_Available', '$3') ";		    
		} elsif($match =~ /Active Service Latency/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ [sec|%]/;
		    if (!-e $global_active_service_latency)	{
				RRDs::create ($global_active_service_latency, "-s $interval", "DS:Min:GAUGE:600:0:U", "DS:Max:GAUGE:600:0:U", "DS:Average:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_service_latency, "--template=Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_latency, "--template=Max", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_latency, "--template=Average", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Service Check Latency', 'Min', '$1'), ";
		    $query_str .= "('$ns_id', 'Service Check Latency', 'Max', '$2'), ";
		    $query_str .= "('$ns_id', 'Service Check Latency', 'Average', '$3') ";		    
		} elsif($match =~ /Active Service Execution Time/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ sec/;
		    if (!-e $global_active_service_execution) {
				RRDs::create ($global_active_service_execution, "-s $interval", "DS:Min:GAUGE:600:0:U", "DS:Max:GAUGE:600:0:U", "DS:Average:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_service_execution, "--template=Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_execution, "--template=Max", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_execution, "--template=Average", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Service Check Execution Time', 'Min', '$1'), ";
		    $query_str .= "('$ns_id', 'Service Check Execution Time', 'Max', '$2'), ";
		    $query_str .= "('$ns_id', 'Service Check Execution Time', 'Average', '$3') ";
		} elsif($match =~ /Active Services Last 1\/5\/15\/60 min/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)/;
		    if (!-e $global_active_service_last) {
				RRDs::create ($global_active_service_last, "-s $interval", "DS:Last_Min:GAUGE:600:0:U", "DS:Last_5_Min:GAUGE:600:0:U", "DS:Last_15_Min:GAUGE:600:0:U", "DS:Last_Hour:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_service_last, "--template=Last_Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_last, "--template=Last_5_Min", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_last, "--template=Last_15_Min", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_service_last, "--template=Last_Hour", "N:" . $4);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Service Actively Checked', 'Last_minute', '$1'), ";
		    $query_str .= "('$ns_id', 'Service Actively Checked', 'Last_5_minutes', '$2'), ";
		    $query_str .= "('$ns_id', 'Service Actively Checked', 'Last_15_minutes', '$3'), ";
		    $query_str .= "('$ns_id', 'Service Actively Checked', 'Last_hour', '$4')";
		} elsif($match =~ /Services Ok\/Warn\/Unk\/Crit/) {	    
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)/;
		    if (!-e $global_services_states) {
				RRDs::create ($global_services_states, "-s $interval", "DS:Ok:GAUGE:600:0:U", "DS:Warn:GAUGE:600:0:U", "DS:Unk:GAUGE:600:0:U", "DS:Crit:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_services_states, "--template=Ok", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_services_states, "--template=Warn", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_services_states, "--template=Unk", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_services_states, "--template=Crit", "N:" . $4);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Services Status', 'OK', '$1'), ";
		    $query_str .= "('$ns_id', 'Services Status', 'Warning', '$2'), ";
		    $query_str .= "('$ns_id', 'Services Status', 'Unknown', '$3'), ";
		    $query_str .= "('$ns_id', 'Services Status', 'Critical', '$4')";
		    
		} elsif($match =~ /Active Host Latency/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ [sec|%]/;
		    if (!-e $global_active_host_latency) {
				RRDs::create ($global_active_host_latency, "-s $interval", "DS:Min:GAUGE:600:0:U", "DS:Max:GAUGE:600:0:U", "DS:Average:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_host_latency, "--template=Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_latency, "--template=Max", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_latency, "--template=Average", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Host Check Latency', 'Min', '$1'), ";
		    $query_str .= "('$ns_id', 'Host Check Latency', 'Max', '$2'), ";
		    $query_str .= "('$ns_id', 'Host Check Latency', 'Average', '$3')";	    
		} elsif($match =~ /Active Host Execution Time/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ sec/;
		    if (!-e $global_active_host_execution) {
				RRDs::create ($global_active_host_execution, "-s $interval", "DS:Min:GAUGE:600:0:U", "DS:Max:GAUGE:600:0:U", "DS:Average:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_host_execution, "--template=Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_execution, "--template=Max", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_execution, "--template=Average", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Host Check Execution Time', 'Min', '$1'), ";
		    $query_str .= "('$ns_id', 'Host Check Execution Time', 'Max', '$2'), ";
		    $query_str .= "('$ns_id', 'Host Check Execution Time', 'Average', '$3')";
		} elsif($match =~ /Active Hosts Last 1\/5\/15\/60 min/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)/;
		    if (!-e $global_active_host_last) {
				RRDs::create ($global_active_host_last, "-s $interval", "DS:Last_Min:GAUGE:600:0:U", "DS:Last_5_Min:GAUGE:600:0:U", "DS:Last_15_Min:GAUGE:600:0:U", "DS:Last_Hour:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_active_host_last, "--template=Last_Min", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_last, "--template=Last_5_Min", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_last, "--template=Last_15_Min", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_active_host_last, "--template=Last_Hour", "N:" . $4);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Host Actively Checked', 'Last_minute', '$1'), ";
		    $query_str .= "('$ns_id', 'Host Actively Checked', 'Last_5_minutes', '$2'), ";
		    $query_str .= "('$ns_id', 'Host Actively Checked', 'Last_15_minutes', '$3'), ";
		    $query_str .= "('$ns_id', 'Host Actively Checked', 'Last_hour', '$4')";
		} elsif($match =~ /Hosts Up\/Down\/Unreach/){
		    $tab[$j+1] = trim($tab[$j+1]);
		    $tab[$j+1] =~ /([0-9\.]*)\ \/\ ([0-9\.]*)\ \/\ ([0-9\.]*)/;
		    if (!-e $global_hosts_states) {
				RRDs::create ($global_hosts_states, "-s $interval", "DS:Up:GAUGE:600:0:U", "DS:Down:GAUGE:600:0:U", "DS:Unreach:GAUGE:600:0:U", "RRA:AVERAGE:0.5:1:1200", "RRA:MIN:0.5:12:2400", "RRA:MAX:0.5:12:2400");
		    }
		    RRDs::update ($global_hosts_states, "--template=Up", "N:" . $1);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_hosts_states, "--template=Down", "N:" . $2);
		    $error = RRDs::error() if RRDs::error();
		    RRDs::update ($global_hosts_states, "--template=Unreach", "N:" . $3);
		    $error = RRDs::error() if RRDs::error();
		    
		    if ($query_str ne "") {
		    	$query_str .= ", ";
		    }
		    $query_str .= "('$ns_id', 'Hosts Status', 'Up', '$1'), ";
		    $query_str .= "('$ns_id', 'Hosts Status', 'Down', '$2'), ";
		    $query_str .= "('$ns_id', 'Hosts Status', 'Unreachable', '$3')";		    
		}
		$j++;
    }
    if (!$error) {
 	   my $rq = "DELETE FROM `nagios_stats` WHERE instance_id = '".$ns_id."'";
	   my $res = $dbh->do($rq);
	   print "SQL INSERT ERROR :" . $rq. "\n" if (!defined($res));
 	   
 	   $rq = "INSERT INTO `nagios_stats` (instance_id, stat_label, stat_key, stat_value) VALUES " . $query_str;
	   $res = $dbh->do($rq);
	   print "SQL INSERT ERROR :" . $rq. "\n" if (!defined($res));
    }
    return $error;
}

sub check_dir($)	{
    my ($nagios_id) = @_;
    my $str;

    if (!-e $global_prefix . "perfmon-" . $nagios_id){
		system("mkdir " . $global_prefix . "perfmon-" . $nagios_id);
		system("chown @NAGIOS_USER@:@NAGIOS_GROUP@ " . $global_prefix . "perfmon-" . $nagios_id);
		system("chmod 775 " . $global_prefix . "perfmon-" . $nagios_id);
    }
    $tmp_prefix = $global_prefix . "perfmon-" . $nagios_id;
    $global_cmd_buffer = $tmp_prefix . "/nagios_cmd_buffer.rrd";
    $global_active_service_latency = $tmp_prefix . "/nagios_active_service_latency.rrd";
    $global_active_service_execution = $tmp_prefix . "/nagios_active_service_execution.rrd";
    $global_active_service_last = $tmp_prefix . "/nagios_active_service_last.rrd";
    $global_services_states = $tmp_prefix . "/nagios_services_states.rrd";
    $global_active_host_latency = $tmp_prefix . "/nagios_active_host_latency.rrd";
    $global_active_host_execution = $tmp_prefix . "/nagios_active_host_execution.rrd";
    $global_active_host_last = $tmp_prefix . "/nagios_active_host_last.rrd";
    $global_hosts_states = $tmp_prefix . "/nagios_hosts_states.rrd";
}

sub get_poller()	{
    use vars qw ($mysql_host $mysql_user $mysql_passwd $mysql_database_oreon $mysql_database_ods);
    require("@CENTREON_ETC@/conf.pm");

    my $item;
    my $id;
    my $ip;
    my $is_localhost;
    my $nagiostats_bin;
    my $cfg_item;
    my $cfg_dir;
    my $nagiostats;
    my $tmp;
    my $must_update_ds;

    my $dbh = DBI->connect("DBI:mysql:database=".$mysql_database_oreon.";host=".$mysql_host, $mysql_user, $mysql_passwd, {'RaiseError' => 1});
    if (defined($dbh)){
		$item = $dbh->prepare("SELECT id, ns_ip_address, localhost, nagiostats_bin FROM nagios_server WHERE ns_activate = 1");
		if (!$item->execute) {die "Error:" . $item->errstr . "\n";}
		while (($id, $ip, $is_localhost, $nagiostats_bin) = $item->fetchrow_array())	{
		    $must_update_ds = 0;
		    $cfg_item = $dbh->prepare("SELECT cfg_dir FROM cfg_nagios WHERE nagios_server_id = " . $id);
		    if (!$cfg_item->execute) {
				die "Error:" . $cfg_item->errstr . "\n";
		    }
		    $cfg_dir = $cfg_item->fetchrow_hashref();
		    if ($is_localhost){
				$nagiostats = `$nagiostats_bin`;
		    } else {
				$tmp = $cfg_dir->{'cfg_dir'};
				$nagiostats = `ssh $ip $nagiostats_bin -c ${tmp}nagios.cfg`;
		    }
		    check_dir($id);
		    if (rrd_process($nagiostats, $is_localhost, $must_update_ds, $id)) {
		    	$must_update_ds = 1;
		    	rrd_process($nagiostats, $is_localhost, $must_update_ds, $id);
		    }
		}
    } else {
		print "\nMysql Database unreachable on host $mysql_host\n";
    }
}

if (!-e $global_prefix){
    system("mkdir " . $global_prefix);
    system("chown @NAGIOS_USER@:@NAGIOS_GROUP@ " . $global_prefix);
    system("chmod 775 " . $global_prefix);
}

get_poller();

$cmdtmp = `rm -rf $lock_file`;

__END__
